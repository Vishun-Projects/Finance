generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model GlobalDesignSettings {
  id                String   @id @default(cuid())
  theme             String   @default("system")
  primaryColor      String   @default("250 85% 40%")
  surfaceColor      String   @default("240 5% 97%")
  accentColor       String   @default("240 4.8% 95.9%")
  borderColor       String   @default("240 5.9% 90%")
  fontFamilyBody    String   @default("Inter")
  fontFamilyHeading String   @default("Inter")
  baseFontSize      Int      @default(16)
  borderRadius      String   @default("0.5rem")
  isActive          Boolean  @default(true)
  updatedAt         DateTime @updatedAt

  @@map("global_design_settings")
}

model UserPreferences {
  id               String   @id @default(cuid())
  userId           String   @unique
  navigationLayout String   @default("sidebar")
  theme            String   @default("light")
  colorScheme      String   @default("default")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  currency         String   @default("INR")
  dateFormat       String   @default("DD/MM/YYYY")
  language         String   @default("en")
  timezone         String   @default("Asia/Kolkata")
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

enum Gender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY
}

enum UserRole {
  USER
  SUPERUSER
}

enum DocumentSourceType {
  USER_UPLOAD
  BANK_STATEMENT
  PORTAL_RESOURCE
  SYSTEM
  SUPER_DOCUMENT
}

enum DocumentVisibility {
  PRIVATE
  ORGANIZATION
  PUBLIC
}

model User {
  id                   String           @id @default(cuid())
  email                String           @unique
  password             String?
  oauthProvider        String?          @db.VarChar(50)
  oauthId              String?          @db.VarChar(255)
  name                 String?
  avatarUrl            String?
  gender               Gender?
  phone                String?
  dateOfBirth          DateTime?
  addressLine1         String?
  addressLine2         String?
  city                 String?
  state                String?
  country              String?          @default("India")
  pincode              String?
  occupation           String?
  bio                  String?          @db.Text
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  isActive             Boolean          @default(true)
  lastLogin            DateTime?
  categories           Category[]
  deadlines            Deadline[]
  goals                Goal[]
  advisorConversations AdvisorConversation[]
  salaryHistories      SalaryHistory[]
  salaryStructures     SalaryStructure[]
  preferences          UserPreferences?
  upiMappings          UpiFieldMapping[]
  entityMappings       EntityMapping[]
  transactions         Transaction[]
  accountStatements    AccountStatement[]
  role                 UserRole         @default(USER)
  uploadedDocuments    Document[]       @relation("DocumentUploadedBy")
  ownedDocuments       Document[]       @relation("DocumentOwner")
  deletedDocuments     Document[]       @relation("DocumentDeletedBy")
  bankFieldMappings    BankFieldMapping[]
  auditEvents          AuditLog[]       @relation("AuditActor")
  auditTargets         AuditLog[]       @relation("AuditTarget")
  status               UserAccountStatus @default(ACTIVE)
  superDocuments       SuperDocument[]   @relation("SuperDocumentUploadedBy")
  wishlistItems        WishlistItem[]
  educationPosts       EducationPost[]   @relation("EducationAuthor")
  educationProgress    EducationProgress[]

  @@map("users")
}

model EducationPost {
  id          String              @id @default(cuid())
  slug        String              @unique
  title       String
  content     String              @db.Text
  excerpt     String?             @db.Text
  category    String              @default("General")
  difficulty  String              @default("Beginner")
  readTime    Int                 @default(5)
  published   Boolean             @default(false)
  authorId    String
  coverImage  String?
  imagePrompt String?             @db.Text
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  author      User                @relation("EducationAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  progress    EducationProgress[]

  @@index([authorId])
  @@index([category])
  @@map("education_posts")
}

model EducationProgress {
  id          String        @id @default(cuid())
  userId      String
  postId      String
  isCompleted Boolean       @default(false)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  post        EducationPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([userId])
  @@index([postId])
  @@map("education_progress")
}

model Category {
  id                      String           @id @default(cuid())
  name                    String
  type                    CategoryType
  color                   String?          @default("#3B82F6")
  icon                    String?
  isDefault               Boolean          @default(false)
  userId                  String?
  parentCategoryId        String?
  parentCategory          Category?        @relation("CategorySubcategories", fields: [parentCategoryId], references: [id], onDelete: SetNull)
  subcategories           Category[]       @relation("CategorySubcategories")
  createdAt               DateTime         @default(now())
  updatedAt               DateTime         @updatedAt
  user                    User?            @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions            Transaction[]
  subcategoryTransactions Transaction[]    @relation("TransactionSubcategory")
  merchantCategories      MerchantCategory[]

  @@index([userId])
  @@index([parentCategoryId])
  @@map("categories")
}

model MerchantCategory {
  id             String    @id @default(cuid())
  merchantName   String    @db.VarChar(255)
  normalizedName String    @db.VarChar(255)
  categoryName   String?   @db.VarChar(255)
  categoryId     String?
  confidence     Decimal?  @db.Decimal(3, 2)
  source         String?   @db.VarChar(50)
  lookupDate     DateTime?
  hitCount       Int       @default(0)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  category       Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  @@unique([normalizedName])
  @@index([normalizedName])
  @@index([categoryId])
  @@map("merchant_categories")
}

model Deadline {
  id             String             @id @default(cuid())
  title          String
  amount         Decimal?           @db.Decimal(10, 2)
  dueDate        DateTime
  isRecurring    Boolean            @default(false)
  frequency      DeadlineFrequency?
  status         DeadlineStatus     @default(PENDING)
  paymentMethod  String?
  accountDetails String?
  notes          String?
  userId         String
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  category       String?
  completedDate  DateTime?
  description    String?
  isCompleted    Boolean            @default(false)
  user           User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("deadlines")
}

model Goal {
  id            String             @id @default(cuid())
  title         String
  targetAmount  Decimal            @db.Decimal(10, 2)
  currentAmount Decimal            @default(0.00) @db.Decimal(10, 2)
  targetDate    DateTime?
  priority      GoalPriority       @default(MEDIUM)
  category      String?
  description   String?
  imageUrl      String?
  isActive      Boolean            @default(true)
  userId        String
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  user          User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  contributions GoalContribution[]

  @@index([userId])
  @@map("goals")
}

model GoalContribution {
  id     String   @id @default(cuid())
  goalId String
  amount Decimal  @db.Decimal(10, 2)
  date   DateTime @default(now())
  source String
  note   String?
  goal   Goal     @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@index([goalId])
  @@map("goal_contributions")
}

model SalaryStructure {
  id                    String          @id @default(cuid())
  jobTitle              String
  company               String
  baseSalary            Decimal         @db.Decimal(10, 2)
  allowances            String?
  deductions            String?
  employerContributions String?
  effectiveDate         DateTime
  endDate               DateTime?
  isActive              Boolean         @default(true)
  currency              String          @default("INR")
  location              String?
  department            String?
  grade                 String?
  notes                 String?
  userId                String
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  salaryHistory         SalaryHistory[]
  user                  User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("salary_structures")
}

model SalaryHistory {
  id                    String           @id @default(cuid())
  salaryStructureId     String
  jobTitle              String
  company               String
  baseSalary            Decimal          @db.Decimal(10, 2)
  allowances            String?
  deductions            String?
  employerContributions String?
  effectiveDate         DateTime
  endDate               DateTime?
  currency              String           @default("INR")
  location              String?
  department            String?
  grade                 String?
  changeType            SalaryChangeType
  changeReason          String?
  userId                String
  createdAt             DateTime         @default(now())
  salaryStructure       SalaryStructure  @relation(fields: [salaryStructureId], references: [id], onDelete: Cascade)
  user                  User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([salaryStructureId])
  @@index([userId])
  @@map("salary_history")
}

model SuperDocument {
  id            String                @id @default(cuid())
  title         String
  description   String?               @db.Text
  category      SuperDocumentCategory
  storageKey    String
  originalName  String
  mimeType      String
  fileSize      Int?
  uploadedById  String
  visibility    DocumentVisibility    @default(PUBLIC)
  processedText String?               @db.Text
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  uploadedBy    User                  @relation("SuperDocumentUploadedBy", fields: [uploadedById], references: [id], onDelete: Cascade)

  @@index([uploadedById])
  @@index([category])
  @@map("super_documents")
}

model AdvisorConversation {
  id        String           @id @default(cuid())
  userId    String
  title     String?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  AdvisorMessage[]

  @@index([userId])
  @@map("advisor_conversations")
}

enum AdvisorMessageRole {
  USER
  ASSISTANT
}

model AdvisorMessage {
  id             String              @id @default(cuid())
  conversationId String
  role           AdvisorMessageRole
  content        String              @db.Text
  sources        Json?
  createdAt      DateTime            @default(now())
  conversation   AdvisorConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@map("advisor_messages")
}

enum CategoryType {
  INCOME
  EXPENSE
}

enum DeadlineFrequency {
  ONE_TIME
  MONTHLY
  QUARTERLY
  YEARLY
}

enum DeadlineStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
}

enum GoalPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum SalaryChangeType {
  NEW_JOB
  PROMOTION
  TRANSFER
  COMPANY_CHANGE
  LOCATION_CHANGE
  DEPARTMENT_CHANGE
  SALARY_REVISION
  OTHER
}

model UpiFieldMapping {
  id        String   @id @default(cuid())
  userId    String
  ruleName  String
  pattern   String   @db.Text
  fieldMap  Json
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("upi_field_mappings")
}

enum EntityType {
  PERSON
  STORE
}

enum TransactionCategory {
  INCOME
  EXPENSE
  TRANSFER
  INVESTMENT
  OTHER
}

model EntityMapping {
  id            String     @id @default(cuid())
  userId        String
  canonicalName String
  mappedNames   Json
  entityType    EntityType
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, entityType])
  @@map("entity_mappings")
}

model Transaction {
  id                 String              @id @default(cuid())
  userId             String
  transactionDate    DateTime
  description        String?
  creditAmount       Decimal             @default(0.00) @db.Decimal(12, 2)
  debitAmount        Decimal             @default(0.00) @db.Decimal(12, 2)
  financialCategory  TransactionCategory @default(EXPENSE)
  categoryId         String?
  subcategoryId      String?
  bankCode           String?
  transactionId      String?
  accountNumber      String?
  transferType       String?
  personName         String?
  upiId              String?
  branch             String?
  store              String?
  rawData            Json?
  balance            Decimal?            @db.Decimal(12, 2)
  isPartialData      Boolean             @default(false)
  hasInvalidDate     Boolean             @default(false)
  hasZeroAmount      Boolean             @default(false)
  parsingMethod      String?
  parsingConfidence  Float?
  rawParsingData     Json?
  notes              String?
  receiptUrl         String?
  isDeleted          Boolean             @default(false)
  deletedAt          DateTime?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  category           Category?           @relation(fields: [categoryId], references: [id])
  subcategory        Category?           @relation("TransactionSubcategory", fields: [subcategoryId], references: [id])
  documentId         String?
  document           Document?           @relation(fields: [documentId], references: [id], onDelete: SetNull)
  accountStatementId String?
  accountStatement   AccountStatement?   @relation(fields: [accountStatementId], references: [id])

  @@index([userId])
  @@index([userId, transactionDate])
  @@index([userId, financialCategory])
  @@index([categoryId])
  @@index([subcategoryId])
  @@index([documentId])
  @@index([accountStatementId])
  @@map("transactions")
}

model Document {
  id              String             @id @default(cuid())
  ownerId         String?
  uploadedById    String
  deletedById     String?
  storageKey      String
  originalName    String
  mimeType        String
  fileSize        Int?
  checksum        String?
  visibility      DocumentVisibility @default(PRIVATE)
  sourceType      DocumentSourceType @default(USER_UPLOAD)
  sourceReference String?
  bankCode        String?
  parsedAt        DateTime?
  metadata        Json?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  deletedAt       DateTime?
  isDeleted       Boolean            @default(false)
  owner           User?              @relation("DocumentOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  uploadedBy      User               @relation("DocumentUploadedBy", fields: [uploadedById], references: [id], onDelete: Cascade)
  deletedBy       User?              @relation("DocumentDeletedBy", fields: [deletedById], references: [id], onDelete: SetNull)
  transactions    Transaction[]

  @@index([ownerId])
  @@index([uploadedById])
  @@index([deletedById])
  @@map("documents")
}

model BankFieldMapping {
  id            String   @id @default(cuid())
  bankCode      String
  fieldKey      String
  mappedTo      String
  description   String?  @db.Text
  version       Int      @default(1)
  isActive      Boolean  @default(true)
  mappingConfig Json?
  createdById   String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  createdBy     User     @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([bankCode, isActive])
  @@index([createdById])
  @@map("bank_field_mappings")
}

enum UserAccountStatus {
  ACTIVE
  FROZEN
  SUSPENDED
}

model AuditLog {
  id             String        @id @default(cuid())
  actorId        String
  event          String
  severity       AuditSeverity @default(INFO)
  targetUserId   String?
  targetResource String?
  message        String?
  metadata       Json?
  ipAddress      String?
  userAgent      String?
  createdAt      DateTime      @default(now())
  actor          User          @relation("AuditActor", fields: [actorId], references: [id], onDelete: Cascade)
  targetUser     User?         @relation("AuditTarget", fields: [targetUserId], references: [id], onDelete: SetNull)

  @@index([actorId])
  @@index([event])
  @@index([targetUserId])
  @@index([createdAt])
  @@map("audit_logs")
}

enum AuditSeverity {
  INFO
  WARN
  ALERT
}

enum SuperDocumentCategory {
  INCOME_TAX
  INVESTMENT
  INSURANCE
  RETIREMENT
  DEBT_MANAGEMENT
  BUDGETING
  SAVINGS
  OTHER
}

model WishlistItem {
  id            String   @id @default(cuid())
  userId        String
  title         String
  description   String?  @db.Text
  estimatedCost Decimal  @db.Decimal(10, 2)
  priority      String   @default("MEDIUM")
  category      String?
  targetDate    DateTime?
  imageUrl      String?
  notes         String?
  tags          String?  @db.Text // Stored as JSON string based on API usage
  isCompleted   Boolean  @default(false)
  completedDate DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("wishlist_items")
}

model AccountStatement {
  id                 String        @id @default(cuid())
  userId             String
  accountNumber      String
  bankCode           String
  statementStartDate DateTime
  statementEndDate   DateTime
  openingBalance     Decimal       @db.Decimal(12, 2)
  closingBalance     Decimal       @db.Decimal(12, 2)
  totalDebits        Decimal       @default(0.00) @db.Decimal(12, 2)
  totalCredits       Decimal       @default(0.00) @db.Decimal(12, 2)
  transactionCount   Int           @default(0)
  importedAt         DateTime      @default(now())
  importedBy         String
  metadata           String?       @db.Text
  isActive           Boolean       @default(true)
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  user               User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions       Transaction[]

  @@index([userId])
  @@index([accountNumber])
  @@map("account_statements")
}

model DailyBriefing {
  id             String   @id @default(cuid())
  date           DateTime @unique // One briefing per day
  location       String   @default("India")
  
  // Quick Summary (JSON)
  summary        Json     // Array of strings
  
  // Metrics
  sentiment      String   // Bullish, Bearish, etc.
  sentimentScore Int      @default(50)
  
  // Full Blog Content
  heroImage      String?  // URL to local or remote image
  title          String?
  content        String?  @db.Text // Full markdown article
  
  // Metadata
  sources        Json?    // Array of {title, link}
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("daily_briefings")
}